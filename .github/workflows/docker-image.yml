# .github/workflows/docker.yml

name: Publish Docker Image to GHCR

# è§¦å‘æ¡ä»¶ï¼šå½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push-ghcr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # å¿…é¡»è¦æœ‰ packages: write æƒé™æ‰èƒ½æ¨é€åˆ° GHCR

    steps:
      - name: â¬‡ï¸ Checkout code
        # è·å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        
      - name: ğŸ› ï¸ Set up Docker Buildx
        # è®¾ç½® Buildxï¼Œå¯ç”¨é«˜çº§æ„å»ºåŠŸèƒ½
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ”‘ Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }} # ä½¿ç”¨è§¦å‘å·¥ä½œæµçš„ GitHub ç”¨æˆ·å
          password: ${{ secrets.GITHUB_TOKEN }} # ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ GitHub Token
          
      - name: âš™ï¸ Set up metadata for image tags
        # è‡ªåŠ¨ç”Ÿæˆæ ‡ç­¾å’Œæ ‡ç­¾ï¼ˆæ¨èï¼‰
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }} # é•œåƒåç§°æ ¼å¼ï¼šghcr.io/<owner>/<repo-name>
          tags: |
            type=sha,format=long,prefix=
            type=raw,value=latest,enable={{is_default_branch}}
            
      - name: ğŸ”¨ Build and Push Docker image to GHCR
        uses: docker/build-push-action@v5
        with:
          context: . # Dockerfile æ‰€åœ¨çš„ç›®å½• (é»˜è®¤ä¸ºä»“åº“æ ¹ç›®å½•)
          push: true # å…³é”®ï¼šè®¾ç½®ä¸º true æ‰ä¼šæ¨é€
          tags: ${{ steps.meta.outputs.tags }} # ä½¿ç”¨ metadata action ç”Ÿæˆçš„æ ‡ç­¾
          labels: ${{ steps.meta.outputs.labels }} # ä½¿ç”¨ metadata action ç”Ÿæˆçš„æ ‡ç­¾
          # dockerfile: ./path/to/Dockerfile # å¦‚æœ Dockerfile ä¸åœ¨æ ¹ç›®å½•ï¼Œè¯·å–æ¶ˆæ³¨é‡Šå¹¶æŒ‡å®šè·¯å¾„
